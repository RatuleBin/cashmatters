{% extends "wagtailadmin/base.html" %}
{% load static wagtailadmin_tags i18n %}

{% block titletag %}{% trans "Blog Management" %}{% endblock %}
{% block bodyclass %}page-explorer{% endblock %}

{% block content %}
    {% trans "Blog Management" as title_trans %}
    {% include "wagtailadmin/shared/header.html" with title=title_trans icon="doc-full-inverse" %}

    <div class="nice-padding">
        <!-- Quick Stats -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="w-panel" style="padding: 1.75rem; text-align: center; border-left: 4px solid #007cba; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="color: #007cba; font-size: 2.25rem; margin: 0 0 0.5rem 0; font-weight: 600;">6</h3>
                <p style="color: #505050; margin: 0; font-size: 0.95rem; font-weight: 500;">Total Posts</p>
            </div>
            <div class="w-panel" style="padding: 1.75rem; text-align: center; border-left: 4px solid #28a745; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="color: #28a745; font-size: 2.25rem; margin: 0 0 0.5rem 0; font-weight: 600;">6</h3>
                <p style="color: #505050; margin: 0; font-size: 0.95rem; font-weight: 500;">Published</p>
            </div>
            <div class="w-panel" style="padding: 1.75rem; text-align: center; border-left: 4px solid #ffc107; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="color: #ffc107; font-size: 2.25rem; margin: 0 0 0.5rem 0; font-weight: 600;">0</h3>
                <p style="color: #505050; margin: 0; font-size: 0.95rem; font-weight: 500;">Drafts</p>
            </div>
            <div class="w-panel" style="padding: 1.75rem; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border: 1px solid #e1e5e9; border-radius: 4px;">
                <a href="/admin/pages/add/blog/blogpage/" class="button" style="background: #007cba; color: white; border: 1px solid #007cba; font-weight: 500; padding: 0.75rem 1.5rem; border-radius: 4px; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.15s ease;">
                    <svg class="icon icon-plus" aria-hidden="true" style="width: 16px; height: 16px;"><use href="#icon-plus"></use></svg>
                    Add New Blog
                </a>
            </div>


            </div>


            </div>

        <!-- Search and Filters -->
        <div class="w-panel" style="margin-bottom: 2rem; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border: 1px solid #e1e5e9; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="padding: 1.75rem; border-bottom: 1px solid #e1e5e9;">
                <h3 style="margin: 0 0 1.5rem 0; color: #32373c; font-size: 1.25rem; font-weight: 600;">Search & Filter Posts</h3>
                <form method="get" style="margin: 0;">
                    <div style="display: grid; grid-template-columns: 2.5fr 1fr 1fr 1fr 1fr auto; gap: 1.25rem; align-items: end;">
                        <!-- Search -->
                        <div>
                            <label for="search" style="display: block; margin-bottom: 0.5rem; color: #505050; font-weight: 500; font-size: 0.9rem;">Search Posts</label>
                            <input type="text" id="search" name="q" value="{{ search_query }}" placeholder="Search by title, intro, or content..." style="width: 100%; padding: 0.75rem; border: 1px solid #c3c4c7; border-radius: 6px; font-size: 0.95rem; background: white; transition: border-color 0.2s ease;">
                        </div>
                        
                        <!-- Category Filter -->
                        <div>
                            <label for="category" style="display: block; margin-bottom: 0.5rem; color: #505050; font-weight: 500; font-size: 0.9rem;">Category</label>
                            <select id="category" name="category" style="width: 100%; padding: 0.75rem; border: 1px solid #c3c4c7; border-radius: 6px; font-size: 0.95rem; background: white; transition: border-color 0.2s ease;">
                                <option value="">All Categories</option>
                                {% for cat in categories %}
                                    <option value="{{ cat }}" {% if category_filter == cat %}selected{% endif %}>{{ cat }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Status Filter -->
                        <div>
                            <label for="status" style="display: block; margin-bottom: 0.5rem; color: #505050; font-weight: 500; font-size: 0.9rem;">Status</label>
                            <select id="status" name="status" style="width: 100%; padding: 0.75rem; border: 1px solid #c3c4c7; border-radius: 6px; font-size: 0.95rem; background: white; transition: border-color 0.2s ease;">
                                <option value="">All Status</option>
                                <option value="live" {% if status_filter == 'live' %}selected{% endif %}>Published</option>
                                <option value="draft" {% if status_filter == 'draft' %}selected{% endif %}>Draft</option>
                            </select>
                        </div>
                        
                        <!-- Location Filter -->
                        <div>
                            <label for="location" style="display: block; margin-bottom: 0.5rem; color: #505050; font-weight: 500; font-size: 0.9rem;">Location</label>
                            <select id="location" name="location" style="width: 100%; padding: 0.75rem; border: 1px solid #c3c4c7; border-radius: 6px; font-size: 0.95rem; background: white; transition: border-color 0.2s ease;">
                                <option value="">All Locations</option>
                                {% for loc in locations %}
                                    <option value="{{ loc }}" {% if location_filter == loc %}selected{% endif %}>{{ loc }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Sector Filter -->
                        <div>
                            <label for="sector" style="display: block; margin-bottom: 0.5rem; color: #505050; font-weight: 500; font-size: 0.9rem;">Sector</label>
                            <select id="sector" name="sector" style="width: 100%; padding: 0.75rem; border: 1px solid #c3c4c7; border-radius: 6px; font-size: 0.95rem; background: white; transition: border-color 0.2s ease;">
                                <option value="">All Sectors</option>
                                {% for sec in sectors %}
                                    <option value="{{ sec }}" {% if sector_filter == sec %}selected{% endif %}>{{ sec }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Buttons -->
                        <div style="display: flex; gap: 0.75rem;">
                            <button type="submit" class="button button-primary" style="background: #007cba; color: white; border: 1px solid #007cba; font-weight: 500; padding: 0.75rem 1.5rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.15s ease; cursor: pointer;">Apply Filters</button>
                            <a href="{% url 'blogs_dashboard_custom' %}" class="button button-secondary" style="background: #f8f9fa; color: #32373c; border: 1px solid #c3c4c7; font-weight: 500; padding: 0.75rem 1.5rem; border-radius: 4px; text-decoration: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.15s ease;">Clear</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Blog Posts Table -->
        <div class="w-panel">


            {% if blog_posts %}
                <form id="bulk-actions-form" method="post">
                    {% csrf_token %}
                    <div style="padding: 1.25rem; background: #f1f1f1; border-bottom: 1px solid #ddd; border-radius: 6px 6px 0 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <input type="checkbox" id="select-all" style="margin: 0; transform: scale(1.1);">
                                <label for="select-all" style="margin: 0; font-weight: 600; color: #32373c; font-size: 0.95rem;">Select All</label>
                            </div>
                            <div id="bulk-actions" style="display: none;">
                                <select name="bulk_action" style="padding: 0.5rem; margin-right: 0.75rem; border: 1px solid #c3c4c7; border-radius: 4px; font-size: 0.9rem; background: white;">
                                    <option value="">Choose action...</option>
                                    <option value="publish">Publish Selected</option>
                                    <option value="unpublish">Unpublish Selected</option>
                                    <option value="delete">Delete Selected</option>
                                </select>
                                <button type="submit" class="button button-small button-secondary" style="font-weight: 500;">Apply</button>
                            </div>
                        </div>
                    </div>

                    <div style="overflow-x: auto; border-radius: 0 0 6px 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <table class="listing" style="border-collapse: separate; border-spacing: 0; width: 100%; background: white;">
                            <thead style="background: #f8f9fa;">
                                <tr>
                                    <th style="width: 50px; padding: 1rem 0.75rem; border-bottom: 2px solid #e1e5e9; font-weight: 600; color: #32373c; font-size: 0.9rem;"></th>
                                    <th class="title" style="padding: 1rem 0.75rem; border-bottom: 2px solid #e1e5e9; font-weight: 600; color: #32373c; font-size: 0.9rem;">
                                        <a href="#" class="icon text-replace icon-arrow-down-after" style="color: #32373c;">Title</a>
                                    </th>
                                    <th style="padding: 1rem 0.75rem; border-bottom: 2px solid #e1e5e9; font-weight: 600; color: #32373c; font-size: 0.9rem;">Category</th>
                                    <th style="padding: 1rem 0.75rem; border-bottom: 2px solid #e1e5e9; font-weight: 600; color: #32373c; font-size: 0.9rem;">Location</th>
                                    <th style="padding: 1rem 0.75rem; border-bottom: 2px solid #e1e5e9; font-weight: 600; color: #32373c; font-size: 0.9rem;">Sector</th>
                                    <th style="padding: 1rem 0.75rem; border-bottom: 2px solid #e1e5e9; font-weight: 600; color: #32373c; font-size: 0.9rem;">Status</th>
                                    <th style="padding: 1rem 0.75rem; border-bottom: 2px solid #e1e5e9; font-weight: 600; color: #32373c; font-size: 0.9rem;">Featured</th>
                                    <th style="padding: 1rem 0.75rem; border-bottom: 2px solid #e1e5e9; font-weight: 600; color: #32373c; font-size: 0.9rem;">Published Date</th>
                                    <th style="padding: 1rem 0.75rem; border-bottom: 2px solid #e1e5e9; font-weight: 600; color: #32373c; font-size: 0.9rem;">Actions</th>
                                </tr>
                            </thead>
                                <tbody>
                                {% for post in blog_posts %}
                                <tr style="border-bottom: 1px solid #e1e5e9; transition: background-color 0.2s ease;">
                                    <td style="padding: 1rem 0.75rem;">
                                        <input type="checkbox" name="selected_posts" value="{{ post.id }}" class="post-checkbox" style="margin: 0;">
                                    </td>
                                    <td class="title" style="padding: 1rem 0.75rem;">
                                        <div class="title-wrapper">
                                            <h2 style="margin: 0 0 0.25rem 0; font-size: 1rem; font-weight: 600; color: #007cba;">
                                                <a href="/admin/pages/{{ post.id }}/edit/" style="color: #007cba; text-decoration: none;">{{ post.title }}</a>
                                            </h2>
                                            {% if post.intro %}
                                                <p class="meta" style="margin: 0; color: #666; font-size: 0.85rem; line-height: 1.4;">{{ post.intro|truncatechars:120 }}</p>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td style="padding: 1rem 0.75rem;">
                                        {% if post.article_types.all %}
                                            {% for type in post.article_types.all %}
                                                <span class="status-tag primary" style="background: #e1f5fe; color: #01579b; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; margin: 0.125rem 0.125rem 0.125rem 0; display: inline-block;">{{ type.name }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="status-tag" style="background: #f5f5f5; color: #666; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">Uncategorized</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 1rem 0.75rem;">
                                        {% if post.locations.all %}
                                            {% for loc in post.locations.all %}
                                                <span class="status-tag secondary" style="background: #f3e5f5; color: #4a148c; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; margin: 0.125rem 0.125rem 0.125rem 0; display: inline-block;">{{ loc.name }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span style="color: #999; font-size: 0.9rem;">—</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 1rem 0.75rem;">
                                        {% if post.sectors.all %}
                                            {% for sec in post.sectors.all %}
                                                <span class="status-tag secondary" style="background: #e8f5e8; color: #1b5e20; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; margin: 0.125rem 0.125rem 0.125rem 0; display: inline-block;">{{ sec.name }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span style="color: #999; font-size: 0.9rem;">—</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 1rem 0.75rem;">
                                        {% if post.live %}
                                            <span class="status-tag primary" style="background: #e8f5e8; color: #1b5e20; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.25rem;">
                                                <svg class="icon icon-tick" aria-hidden="true" style="width: 12px; height: 12px;"><use href="#icon-tick"></use></svg>
                                                Published
                                            </span>
                                        {% else %}
                                            <span class="status-tag warning" style="background: #fff3cd; color: #856404; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.25rem;">
                                                <svg class="icon icon-edit" aria-hidden="true" style="width: 12px; height: 12px;"><use href="#icon-edit"></use></svg>
                                                Draft
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 1rem 0.75rem;">
                                        {% if post.featured %}
                                            <span class="status-tag success" style="background: #fff3cd; color: #856404; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">★ Featured</span>
                                        {% else %}
                                            <span style="color: #999; font-size: 0.9rem;">—</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 1rem 0.75rem; color: #505050; font-size: 0.9rem;">
                                        {% if post.first_published_at %}
                                            {{ post.first_published_at|date:"M j, Y" }}
                                        {% else %}
                                            <span style="color: #999; font-style: italic;">Not published</span>
                                        {% endif %}
                                    </td>
                                    <td class="actions" style="padding: 1rem 0.75rem;">
                                        <div class="actions__list" style="display: flex; gap: 0.5rem;">
                                            {% if post.live %}
                                                <a href="{{ post.url }}" class="button button-small button-secondary" target="_blank" title="View live" style="padding: 0.375rem 0.75rem; font-size: 0.8rem;">
                                                    <svg class="icon icon-view" aria-hidden="true" style="width: 14px; height: 14px;"><use href="#icon-view"></use></svg>
                                                </a>
                                            {% endif %}
                                            <a href="/admin/pages/{{ post.id }}/edit/" class="button button-small button-secondary" title="Edit" style="padding: 0.375rem 0.75rem; font-size: 0.8rem;">
                                                <svg class="icon icon-edit" aria-hidden="true" style="width: 14px; height: 14px;"><use href="#icon-edit"></use></svg>
                                            </a>
                                            <a href="/admin/pages/{{ post.id }}/delete/" class="button button-small button-secondary no" title="Delete" onclick="return confirm('Are you sure you want to delete this post?')" style="padding: 0.375rem 0.75rem; font-size: 0.8rem;">
                                                <svg class="icon icon-bin" aria-hidden="true" style="width: 14px; height: 14px;"><use href="#icon-bin"></use></svg>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                        </tbody>
                    </table>
                </form>

                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                    <div style="padding: 1.5rem; text-align: center; border-top: 1px solid #e1e5e9; background: #f8f9fa; border-radius: 0 0 6px 6px;">
                        <div class="pagination" style="display: flex; justify-content: center; align-items: center; gap: 0.5rem;">
                            {% if page_obj.has_previous %}
                                <a href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if category_filter %}category={{ category_filter }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if location_filter %}location={{ location_filter }}&{% endif %}{% if sector_filter %}sector={{ sector_filter }}&{% endif %}page={{ page_obj.previous_page_number }}" class="button button-small" style="padding: 0.5rem 1rem; background: white; color: #007cba; border: 1px solid #007cba; border-radius: 4px; text-decoration: none; font-weight: 500;">Previous</a>
                            {% endif %}

                            <span style="color: #666; font-weight: 500; padding: 0 1rem;">
                                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                <span style="color: #999; font-weight: normal;">({{ page_obj.paginator.count }} total posts)</span>
                            </span>

                            {% if page_obj.has_next %}
                                <a href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if category_filter %}category={{ category_filter }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if location_filter %}location={{ location_filter }}&{% endif %}{% if sector_filter %}sector={{ sector_filter }}&{% endif %}page={{ page_obj.next_page_number }}" class="button button-small" style="padding: 0.5rem 1rem; background: #007cba; color: white; border: 1px solid #007cba; border-radius: 4px; text-decoration: none; font-weight: 500;">Next</a>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% else %}
                <div style="padding: 4rem 2rem; text-align: center; background: white; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <svg class="icon icon-doc-empty" style="width: 4rem; height: 4rem; opacity: 0.3; color: #c3c4c7;" aria-hidden="true"><use href="#icon-doc-empty"></use></svg>
                    <h3 style="margin: 1.5rem 0 0.75rem 0; color: #32373c; font-size: 1.25rem; font-weight: 600;">No blog posts found</h3>
                    <p style="color: #666; margin: 0 0 2rem 0; font-size: 1rem; max-width: 400px; margin-left: auto; margin-right: auto;">
                        {% if search_query or category_filter or status_filter or location_filter or sector_filter %}
                            No posts match your current search and filter criteria. Try adjusting your filters or search terms.
                        {% else %}
                            Get started by creating your first blog post. Content management has never been easier.
                        {% endif %}
                    </p>
                    <a href="{% url 'blog:create_blog_post' 10 %}" class="button button-primary button-large" style="font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <svg class="icon icon-plus" aria-hidden="true"><use href="#icon-plus"></use></svg>
                        {% if search_query or category_filter or status_filter or location_filter or sector_filter %}
                            Add New Blog
                        {% else %}
                            Add Your First Blog
                        {% endif %}
                    </a>
                        <svg class="icon icon-plus" aria-hidden="true" style="width: 16px; height: 16px;"><use href="#icon-plus"></use></svg>
                        {% if search_query or category_filter or status_filter or location_filter or sector_filter %}
                            Add New Blog
                        {% else %}
                            Add Your First Blog
                        {% endif %}
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Select all checkbox functionality
        document.getElementById('select-all').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.post-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
            toggleBulkActions();
        });

        // Individual checkbox change
        document.querySelectorAll('.post-checkbox').forEach(cb => {
            cb.addEventListener('change', toggleBulkActions);
        });

        function toggleBulkActions() {
            const checkedBoxes = document.querySelectorAll('.post-checkbox:checked');
            const bulkActions = document.getElementById('bulk-actions');
            bulkActions.style.display = checkedBoxes.length > 0 ? 'block' : 'none';
        }

        // Add hover effects for table rows
        document.querySelectorAll('tbody tr').forEach(row => {
            row.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#f8f9fa';
            });
            row.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '';
            });
        });

        // Add hover effects for buttons
        document.querySelectorAll('a[href*="create_blog_post"]').forEach(button => {
            button.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#005a87';
                this.style.boxShadow = '0 2px 6px rgba(0,0,0,0.15)';
                this.style.transform = 'translateY(-1px)';
            });
            button.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '#007cba';
                this.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                this.style.transform = 'translateY(0)';
            });
        });

        // Add focus styles for form inputs
        document.querySelectorAll('input, select').forEach(element => {
            element.addEventListener('focus', function() {
                this.style.borderColor = '#007cba';
                this.style.boxShadow = '0 0 0 2px rgba(0, 124, 186, 0.2)';
            });
            element.addEventListener('blur', function() {
                this.style.borderColor = '#c3c4c7';
                this.style.boxShadow = '';
            });
        });

        // Add focus effects for checkboxes
        document.querySelectorAll('.post-checkbox').forEach(checkbox => {
            checkbox.addEventListener('focus', function() {
                this.parentElement.style.outline = '2px solid #007cba';
                this.parentElement.style.outlineOffset = '2px';
            });
            checkbox.addEventListener('blur', function() {
                this.parentElement.style.outline = '';
                this.parentElement.style.outlineOffset = '';
            });
        });
    </script>
{% endblock %}